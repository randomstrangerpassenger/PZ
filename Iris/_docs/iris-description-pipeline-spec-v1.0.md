# Iris 설명 생성 파이프라인 스펙

**버전**: 1.0  
**상태**: FINAL  
**문서 유형**: 파이프라인 명세서

---

## 1. 목적

이 문서는 Iris 메뉴의 **아이템 설명 생성 과정**을 정의한다.

### 1.1 한 줄 요약

> **분류 결과를 해석하지 않고, 이미 고정된 재료들을 정해진 순서대로 조합한다.**

### 1.2 이 문서가 다루는 것

- 설명 생성의 입력과 출력
- 파이프라인 단계별 처리 규칙
- 블록 활성화 조건
- 금지 사항

### 1.3 이 문서가 다루지 않는 것

- 분류 규칙 (Evidence Table, Rule DSL 관할)
- 템플릿 문장 내용 (소분류 템플릿 문서 관할)
- UI/UX 레이아웃 (별도 문서)

---

## 2. 입력 / 출력 정의

### 2.1 입력

| 항목 | 설명 | 출처 |
|------|------|------|
| 아이템 | 설명을 생성할 대상 아이템 1개 | 게임 데이터 |
| 소분류 목록 | 해당 아이템에 부여된 소분류 태그 집합 (0~N개) | 분류 엔진 출력 |
| 소분류 템플릿 | 각 소분류별 설명 블록 | iris-subcategory-template-v1.1.md |
| 주 소분류 메타 (선택) | `primary_subcategory` 값 | iris_meta.json |

### 2.2 출력

| 항목 | 설명 |
|------|------|
| 설명 블록 리스트 | Iris 메뉴에 표시될 최종 설명 |
| 형식 | 순서가 있는 텍스트 블록의 배열 |

### 2.3 출력 예시

```
[Tool · Construction (1-A)]
이 아이템은 건설이나 제작 작업에 사용되는 도구다.
특정 구조물이나 가구를 만들거나 조립할 때 필요하다.

[Combat · Short Blunt (2-C)]
이 아이템은 근접 전투에서 둔기 계열 무기로 취급된다.
한 손으로 사용할 수 있다.
```

---

## 3. 파이프라인 단계

### 3.0 전체 흐름도

```
┌─────────────┐
│  아이템     │
└──────┬──────┘
       ▼
┌─────────────────────────────┐
│ 단계 1: 소분류 수집          │
│ (Collection)                │
└──────┬──────────────────────┘
       ▼
┌─────────────────────────────┐
│ 단계 2: 주 소분류 결정       │
│ (Anchor)                    │
└──────┬──────────────────────┘
       ▼
┌─────────────────────────────┐
│ 단계 3: 소분류 정렬          │
│ (Ordering)                  │
└──────┬──────────────────────┘
       ▼
┌─────────────────────────────┐
│ 단계 4: 템플릿 바인딩        │
│ (Template Bind)             │
└──────┬──────────────────────┘
       ▼
┌─────────────────────────────┐
│ 단계 5: 블록 활성화          │
│ (Block Activation)          │
└──────┬──────────────────────┘
       ▼
┌─────────────────────────────┐
│ 단계 6: 빈 블록 처리         │
│ (Empty Handling)            │
└──────┬──────────────────────┘
       ▼
┌─────────────────────────────┐
│ 단계 7: 최종 조합            │
│ (Render)                    │
└──────┬──────────────────────┘
       ▼
┌─────────────┐
│  설명 출력  │
└─────────────┘
```

---

### 3.1 단계 1: 소분류 수집 (Collection)

**목적**: 아이템에 부여된 모든 소분류 태그를 수집한다.

**입력**: 아이템

**출력**: 소분류 태그 집합

**규칙**:

| 규칙 | 설명 |
|------|------|
| 중복 허용 | 동일 소분류 태그가 여러 경로로 산출되더라도,
최종 소분류 집합에는 1개만 포함한다. |
| 공백 허용 | 소분류가 0개여도 오류 아님 |
| 순서 무의미 | 이 단계에서는 순서를 고려하지 않음 |

**예시**:

```
입력: Base.Hammer
출력: { Tool.1-A, Tool.1-B, Combat.2-C }
```

---

### 3.2 단계 2: 주 소분류 결정 (Anchor)

**목적**: 설명 블록의 정렬 기준이 될 주 소분류를 결정한다.

**입력**: 소분류 집합, iris_meta (선택)

**출력**: 주 소분류 1개

**규칙**:

```
IF primary_subcategory가 iris_meta에 명시됨:
    anchor = primary_subcategory
ELSE:
    anchor = 대분류 번호 순 첫 번째 소분류
```

**대분류 번호 순서**:

| 순서 | 대분류 |
|------|--------|
| 1 | Tool (1) |
| 2 | Combat (2) |
| 3 | Consumable (3) |
| 4 | Resource (4) |
| 5 | Literature (5) |
| 6 | Wearable (6) |

**동일 대분류 내 순서**: 소분류 코드 순 (A → B → C → ...)

**예시**:

```
입력: { Combat.2-C, Tool.1-A, Tool.1-B }
iris_meta: 없음
출력: Tool.1-A (대분류 번호 순 첫 번째)
```

```
입력: { Combat.2-C, Tool.1-D }
iris_meta: { primary_subcategory: "Tool.1-D" }
출력: Tool.1-D (명시적 지정)
```

**금지**:

| 금지 | 이유 |
|------|------|
| 중요도 판단 | 주 소분류는 판정이 아님 |
| 자동 추론 | Evidence 기반 자동 결정 금지 |

---

### 3.3 단계 3: 소분류 정렬 (Ordering)

**목적**: 설명 블록의 표시 순서를 결정한다.

**입력**: 소분류 집합, 주 소분류

**출력**: 정렬된 소분류 리스트

**규칙**:

```
[주 소분류] + [나머지 소분류 (대분류 번호 순)]
```

**예시**:

```
입력: { Combat.2-C, Tool.1-A, Tool.1-B }, anchor = Tool.1-A
출력: [ Tool.1-A, Tool.1-B, Combat.2-C ]
```

**금지**:

| 금지 | 이유 |
|------|------|
| 알파벳 정렬 | 의미 없는 기준 |
| 중요도 판단 | Iris는 우열을 판단하지 않음 |
| 빈도 기반 정렬 | 통계적 추론 금지 |

---

### 3.4 단계 4: 템플릿 바인딩 (Template Bind)

**목적**: 각 소분류에 해당하는 템플릿 블록을 연결한다.

**입력**: 정렬된 소분류 리스트

**출력**: (소분류, 템플릿 블록) 쌍의 리스트

**규칙**:

| 규칙 | 설명 |
|------|------|
| 1:1 매핑 | 소분류 1개 = 템플릿 블록 1개 |
| 템플릿 출처 | iris-subcategory-template-v1.1.md |
| 수정 금지 | 템플릿 문장을 런타임에 수정하지 않음 |

**예시**:

```
입력: [ Tool.1-A, Combat.2-C ]
출력: [
  (Tool.1-A, "이 아이템은 건설이나 제작 작업에..."),
  (Combat.2-C, "이 아이템은 근접 전투에서 둔기...")
]
```

---

### 3.5 단계 5: 블록 활성화 (Block Activation)

**목적**: 템플릿 블록의 활성화 여부를 결정한다.

**입력**: (소분류, 템플릿 블록) 쌍의 리스트

**출력**: 활성화된 블록 리스트

**핵심 규칙**:

> **소분류 태그가 존재하면, 해당 템플릿 블록 전체를 활성화한다.**

**상세 규칙**:

| 규칙 | 설명 |
|------|------|
| 블록 단위 활성화 | 문장 단위 분기 없음 |
| 조건 = 태그 존재 | Evidence 재검사 없음 |
| 템플릿 전체 표시 | 블록 내 문장은 조건 없이 함께 표시 |

**예시**:

```
소분류 Tool.1-A 존재 → Tool.1-A 블록 전체 활성화
소분류 Combat.2-C 존재 → Combat.2-C 블록 전체 활성화
```

**금지**:

| 금지 | 이유 |
|------|------|
| 문장별 Evidence 분기 | 템플릿은 의미적으로 완결된 블록 |
| 부분 활성화 | 블록 전체가 단위 |
| 조건부 문장 생성 | 런타임 문장 생성 금지 |

**설계 근거**:

- Evidence는 **분류 단계**에서 이미 사용됨
- 설명 단계에서는 **분류 결과를 그대로 표시**
- 중간에 Evidence를 다시 끼워 넣지 않음

```
Evidence → 분류 (여기서 Evidence 사용)
분류 → 설명 (여기서는 분류 결과만 사용)
```

---

### 3.6 단계 6: 빈 블록 처리 (Empty Handling)

**목적**: 소분류가 0개인 경우를 처리한다.

**입력**: 활성화된 블록 리스트

**출력**: 최종 블록 리스트 (변경 없거나 빈 리스트)

**규칙**:

| 상황 | 처리 |
|------|------|
| 소분류 0개 | 설명 없음 (빈 출력) |
| 템플릿 없는 소분류 | 해당 블록 생략 |

**금지**:

| 금지 | 이유 |
|------|------|
| 자동 보완 | "기본 설명" 생성 금지 |
| 대체 문구 | "정보 없음" 같은 문구 금지 |
| 폴백 로직 | 없으면 없는 것 |

**설계 근거**: Fail-loud 원칙. 빈 결과는 **의도된 상태**다.

---

### 3.7 단계 7: 최종 조합 (Render)

**목적**: 활성화된 블록들을 최종 출력 형식으로 조합한다.

**입력**: 활성화된 블록 리스트

**출력**: 최종 설명 텍스트

**형식**:

```
[소분류 A 표시명]
템플릿 문장 1
템플릿 문장 2

[소분류 B 표시명]
템플릿 문장 1
```

**규칙**:

| 항목 | 규칙 |
|------|------|
| 헤더 | 소분류 표시명 (예: "Tool · Construction (1-A)") |
| 순서 | 단계 3의 정렬 결과 유지 |
| 구분 | 블록 간 빈 줄 1개 |
| 문장 | 템플릿 그대로, 수정 없음 |

---

## 4. 블록 활성화 규칙 표

A 방향 채택으로 인해, 활성화 규칙은 단순합니다:

| 조건 | 결과 |
|------|------|
| 소분류 태그 존재 | 해당 템플릿 블록 전체 활성화 |
| 소분류 태그 부재 | 해당 블록 비활성화 (표시 안 함) |

**전체 소분류 목록**:

| 대분류 | 소분류 | 활성화 조건 |
|--------|--------|-------------|
| Tool | 1-A ~ 1-J | 해당 태그 존재 |
| Combat | 2-A ~ 2-L | 해당 태그 존재 |
| Consumable | 3-A ~ 3-E | 해당 태그 존재 |
| Resource | 4-A ~ 4-F | 해당 태그 존재 |
| Literature | 5-A ~ 5-D | 해당 태그 존재 |
| Wearable | 6-A ~ 6-G | 해당 태그 존재 |

---

## 5. 금지 사항

### 5.1 절대 금지

| 금지 | 예시 | 이유 |
|------|------|------|
| 해석 | "이 아이템은 주로 ~에 쓰입니다" | Iris는 해석하지 않음 |
| 평가 | "초반에 유용", "효율적" | 판단 금지 |
| 요약 | "다목적 도구" | 추상화 금지 |
| 추천 | "이걸 추천합니다" | 정책 금지 |
| 비교 | "A보다 강하다" | 우열 판단 금지 |
| 수치 비교 | "공격력이 높다" | 수치 평가 금지 |
| 문장 생성 | 런타임에 새 문장 작성 | 템플릿 외 문장 금지 |
| 문장 수정 | 템플릿 문장 변형 | 원본 유지 필수 |

### 5.2 조건부 금지

| 금지 | 조건 | 이유 |
|------|------|------|
| Evidence 재검사 | 단계 5에서 | 분류 단계에서 이미 처리됨 |
| 문장별 분기 | 블록 내부에서 | 블록 단위 활성화 원칙 |

---

## 6. 예시: 전체 파이프라인

### 6.1 입력

```
아이템: Base.Hammer
분류 결과: { Tool.1-A, Tool.1-B, Combat.2-C }
iris_meta: 없음
```

### 6.2 단계별 처리

**단계 1 (수집)**:
```
{ Tool.1-A, Tool.1-B, Combat.2-C }
```

**단계 2 (앵커)**:
```
anchor = Tool.1-A (대분류 번호 순 첫 번째)
```

**단계 3 (정렬)**:
```
[ Tool.1-A, Tool.1-B, Combat.2-C ]
```

**단계 4 (바인딩)**:
```
[
  (Tool.1-A, "이 아이템은 건설이나 제작 작업에 사용되는 도구다..."),
  (Tool.1-B, "이 아이템은 가전제품이나 전자기기를 분해하는 데..."),
  (Combat.2-C, "이 아이템은 근접 전투에서 둔기 계열 무기로...")
]
```

**단계 5 (활성화)**:
```
모든 블록 활성화 (태그 존재)
```

**단계 6 (빈 블록)**:
```
빈 블록 없음, 통과
```

**단계 7 (조합)**:
```
[Tool · Construction (1-A)]
이 아이템은 건설이나 제작 작업에 사용되는 도구다.
특정 구조물이나 가구를 만들거나 조립할 때 필요하다.

[Tool · Disassembly (1-B)]
이 아이템은 가전제품이나 전자기기를 분해하는 데 사용된다.
특정 아이템을 우클릭하여 분해할 수 있다.

[Combat · Short Blunt (2-C)]
이 아이템은 근접 전투에서 둔기 계열 무기로 취급된다.
한 손으로 사용할 수 있다.
```

---

## 7. 문서 관계

```
┌─────────────────────────────────────────────────────────────┐
│              iris-item-description-spec-v1.0                │
│              (설명 설계 원칙)                                │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────────┐   ┌───────────────────┐
│ 이 문서        │   │ subcategory-      │   │ iris_meta.json    │
│ (파이프라인)   │   │ template-v1.1     │   │ (주 소분류 메타)   │
│               │   │ (템플릿 문장)      │   │                   │
└───────────────┘   └───────────────────┘   └───────────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              ▼
                    ┌───────────────────┐
                    │ 구현 코드          │
                    │ (Lua)             │
                    └───────────────────┘
```

---

## 8. 변경 이력

| 버전 | 날짜 | 내용 |
|------|------|------|
| 1.0 | 2026-01-28 | 최초 작성. A 방향(블록 단위 활성화) 채택 |
