# Area 7: WorldItem & Corpse Governor

## 불변 원칙 (Invariants)

1. **Pulse는 신호(Signal)만 제공, Fuse가 정책(Policy) 결정**
   - Pulse Core는 데이터 수집 및 훅 제공만 수행
   - 모든 최적화 판단은 Fuse Governor가 담당

2. **알고리즘 교체/정확도 변경 금지**
   - 기존 게임 로직의 알고리즘을 변경하지 않음
   - 결과의 정확도를 변경하지 않음

3. **행동 의미(Behavioral Semantics) 100% 보존**
   - 플레이어가 관찰 가능한 모든 동작은 동일하게 유지
   - 내부 최적화는 플레이어에게 투명해야 함

## 절대 금지 목록 (Never)

### ❌ 아이템/시체 삭제 또는 합치기
- WorldItem 객체를 삭제하거나 제거하지 않음
- 여러 아이템을 하나로 합치지 않음
- 시체(Corpse) 객체를 삭제하지 않음

### ❌ 물리 알고리즘 변경
- 아이템 물리 계산 로직을 변경하지 않음
- 충돌 감지 알고리즘을 변경하지 않음
- 중력/마찰 등 물리 파라미터 변경 금지

### ❌ 부패/썩음 속도 변경
- 시체 부패 속도 변경 금지
- 음식 부패 속도 변경 금지
- 시간 기반 상태 변화 알고리즘 변경 금지

### ❌ 렌더링 변경
- 렌더링과 update는 별개
- 시각적 표현을 변경하지 않음
- 렌더링 주기는 Area 7의 범위 밖

### ❌ 상호작용 지연/차단
- 플레이어의 아이템 pickup 지연 금지
- 컨테이너 열기 지연 금지
- 루팅 동작 지연 금지

## 허용 목록 (Allowed)

### ✅ update() 호출 빈도 조정
- update() 메서드 호출 주기를 조정할 수 있음
- 단, 최종 결과는 동일해야 함 (시간 분산만 허용)
- 예: 매 틱 대신 2틱마다 실행 (누적 결과는 동일)

### ✅ 비가시/원거리 객체 업데이트 주기 감소
- 플레이어 시야 밖 객체는 업데이트 빈도 감소 가능
- 원거리 객체는 더 낮은 빈도로 업데이트 가능
- 단, 플레이어 접근 시 즉시 정상 주기로 복귀

### ✅ Sleep 모드
- update 완전 중지 가능 (단, 객체 존재는 유지)
- 조건: 플레이어가 관찰 불가능한 상황에서만
- 예: 루팅 완료된 시체 + 원거리 + 비가시

### ✅ 폭주 감지 시 보수적 모드 전환
- 대량 아이템 생성 감지 시 임시 Sleep 모드 진입 가능
- 시스템 안정화 후 자동 복구

## 철수 조건 (Instant Retreat)

다음 조건에서는 **즉시 최적화를 중단**하고 정상 모드로 복귀:

### 1. 플레이어 근접 (20타일 이내)
- 거리: `distance_sq < 400` (20²)
- update() 매 틱 정상 실행

### 2. 상호작용 UI 열림
- 컨테이너 UI 열림
- 루팅 UI 활성화
- 아이템 드래그 중

### 3. 전투 상태 진입
- 플레이어 전투 상태
- 좀비 공격 범위 내

### 4. 충돌 이벤트 감지
- 물리 충돌 발생
- 아이템 이동 중

## 성능 목표

### 시나리오 S7-A: 누적 붕괴 (Erosion)
- 조건: 아이템 140개+ 바닥 드롭, 10분 관측
- 목표: tick p99 악화 없음, worst spike 감소

### 시나리오 S7-B: 폭주 (Burst)
- 조건: 탄피 500개+ / 1분, 시체 30/60/100개
- 목표: FPS 저하 방지, 자동 Shell Shock 발동

## 회귀 방지 체크리스트

구현 완료 후 다음 항목 필수 검증:

- [ ] 아이템 pickup 반응 속도 유지
- [ ] 시체 루팅 반응 속도 유지
- [ ] 아이템 물리 (근거리) 정상 동작
- [ ] 아이템 부패 속도 변화 없음
- [ ] 시체 부패 속도 변화 없음
- [ ] 컨테이너 상호작용 정상 동작

## 아키텍처 원칙

### Pulse (신호 계층)
- `WorldObjectSampler`: 통계 수집만
- `OptimizableEntity`: Duck typing 필드 제공만
- `IWorldObjectThrottlePolicy`: 인터페이스 정의만

### Fuse (정책 계층)
- `ItemGovernor`: 모든 최적화 판단
- `Area7Invariants`: 불변 원칙 상수화
- Mixin: 훅 제공 및 정책 호출만

## 안전 장치

### Fail-soft
- Mixin에서 예외 발생 시 정상 실행으로 자동 복귀
- Governor 에러 5회 연속 시 RETREAT 상태로 전환

### Starvation 방지
- 최대 스킵 시간: 120 ticks (2초)
- 초과 시 강제 업데이트 실행

### ShellShock Guard
- 초당 아이템 생성 50개 이상 감지 시 발동
- 신규 아이템 임시 SLEEP 모드
- 안정화 후 자동 해제

## 설정 가능 파라미터

| 파라미터 | 보수적 | 기본값 | 공격적 |
|---------|--------|--------|--------|
| `RETREAT_DIST_SQ` | 625 | 400 | 256 |
| `MEDIUM_DIST_SQ` | 2500 | 1600 | 900 |
| `FAR_DIST_SQ` | 10000 | 6400 | 3600 |
| `shellShockThreshold` | 100 | 50 | 30 |
| `overloadThreshold` | 1500 | 1000 | 500 |
| `MAX_SKIP_TICKS` | 180 | 120 | 60 |

## 버전 정보

- **Area**: 7 - 경로/충돌/물리 (아이템 및 시체 제어)
- **Fuse Version**: v2.2
- **Dependencies**: Phase 8 (IOGuard), Phase 10 (GCPressureGuard)
- **Risk Level**: 중간-높음 (상호작용 회귀 표면적이 큼)
